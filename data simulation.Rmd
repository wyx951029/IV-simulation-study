---
title: "data simulation"
author: "Yixuan Wang"
date: "11/29/2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
suppressWarnings(library(ggplot2))
suppressWarnings(library(knitr))
```

Medicine A&B treat on the same disease but have risk of side effect W.

## Data Generation-Population size=20000

### Treatment Assignment
```{r}
# Patients characteristics
X1=rbinom(10000, size=1, prob=0.4) # gender
X2=rbinom(10000, size=1, prob=0.1) # age >= 75
X3=round(rnorm(10000, mean=23, sd=3)) # BMI 
X4=round(rnorm(10000, mean=130, sd=7)) # blood pressure systolic
X5=rbinom(10000, size=1, prob=0.1) # history of side effect related disease # unmeasured confounder 
C=data.frame(cbind(X1,X2,X3,X4,X5)) 

# Physician assignments
patientid=c(1:10000)
physicianid=sample(c(1:100))
pp=sample(c(rep(0,50),rep(1,50)))
df=data.frame(cbind(patientid,C,physicianid,pp))
df$X1=as.numeric(df$X1)
df$X2=as.numeric(df$X2)
df$X3=as.numeric(df$X3)
df$X4=as.numeric(df$X4)
df$X5=as.numeric(df$X5)
df$pp=as.numeric(df$pp)
df10=df
df10$trt=NA
df20=df
df20$trt=NA
df30=df
df30$trt=NA

# treatment assignment
for(i in 1:nrow(df10))
    {
    prob=0.02+0.3*df10$pp[i]+0.02*df10$X1[i]-0.012*df10$X2[i]+0.006*df10$X3[i]-0.0005*df10$X4[i]-0.03*df10$X5[i]
    df10$trt[i]=rbinom(1,1,prob)
  }


for(i in 1:nrow(df20))
    {
    prob=0.02+0.5*df20$pp[i]+0.02*df20$X1[i]-0.012*df20$X2[i]+0.006*df20$X3[i]-0.0005*df20$X4[i]-0.03*df20$X5[i]
    df20$trt[i]=rbinom(1,1,prob)
  }


for(i in 1:nrow(df30))
    {
    prob=0.02+0.7*df30$pp[i]+0.02*df30$X1[i]-0.012*df30$X2[i]+0.006*df30$X3[i]-0.0005*df30$X4[i]-0.03*df30$X5[i]
    df30$trt[i]=rbinom(1,1,prob)
  }
df30$trt[is.na(df30$trt)]=1
```

### Outcome W-binary

The outcome is whether the side effect appears
```{r Relatively frequent binary outcome} 

## x3 is unmeasured confounder, coefficient = 0.3
## df10 

df10_1 = df10
df10_1$W = NA
#df10_1$p = NA

## assuming the exclusion restriction holds

prob = rep(NA, 10000)

for(i in 1:10000)
  {
    prob[i]=13-0.2*df10_1$trt[i]+0.4*df10_1$X1[i]-0.39*df10_1$X2[i]+0.07*df10_1$X3[i]-0.12*df10_1$X4[i]-0.3*df10_1$X5[i]
    df10_1$W[i]=rbinom(1,1,1/(1+exp(-prob[i])))
}

## df20

df20_1 = df20 
df20_1$W = NA

## assuming the exclusion restriction holds

prob = rep(NA, 10000)

for(i in 1:10000)
  {
  
  prob[i]=13-0.2*df20_1$trt[i]+0.4*df20_1$X1[i]-0.39*df20_1$X2[i]+0.07*df20_1$X3[i]-0.12*df20_1$X4[i]-0.3*df20_1$X5[i]
    df20_1$W[i]=rbinom(1,1,1/(1+exp(-prob[i])))
}


## df30

df30_1 = df30
df30_1$W = NA

## assuming the exclusion restriction holds

prob = rep(NA, 10000)

for(i in 1:10000)
  {
   prob[i]=13-0.2*df30_1$trt[i]+0.4*df30_1$X1[i]-0.39*df30_1$X2[i]+0.07*df30_1$X3[i]-0.12*df30_1$X4[i]-0.3*df30_1$X5[i]
    df30_1$W[i]=rbinom(1,1,1/(1+exp(-prob[i])))
}

```



```{r}

## x3 is unmeasured confounder, coefficient = 0.4
## df10 

df10_2 = df10
df10_2$W = NA

## assuming the exclusion restriction holds

prob = rep(NA, 10000)

for(i in 1:10000)
  {
  
  prob[i]=13-0.2*df10_2$trt[i]+0.4*df10_2$X1[i]-0.39*df10_2$X2[i]+0.07*df10_2$X3[i]-0.12*df10_2$X4[i]-0.4*df10_2$X5[i]
  df10_2$W[i]=rbinom(1,1,1/(1+exp(-prob[i])))
  
}


## df20

df20_2 = df20 
df20_2$W = NA

## assuming the exclusion restriction holds

prob = rep(NA, 10000)

for(i in 1:10000)
  {
  
  prob[i]=13-0.2*df20_2$trt[i]+0.4*df20_2$X1[i]-0.39*df20_2$X2[i]+0.07*df20_2$X3[i]-0.12*df20_2$X4[i]-0.4*df20_2$X5[i]
  df20_2$W[i]=rbinom(1,1,1/(1+exp(-prob[i])))
  
}

## df30

df30_2 = df30
df30_2$W = NA

## assuming the exclusion restriction holds

prob = rep(NA, 10000)

for(i in 1:10000)
  {
  prob[i]=13-0.2*df30_2$trt[i]+0.4*df30_2$X1[i]-0.39*df30_2$X2[i]+0.07*df30_2$X3[i]-0.12*df30_2$X4[i]-0.4*df30_2$X5[i]
  df30_2$W[i]=rbinom(1,1,1/(1+exp(-prob[i])))
}

```



```{r}

## x3 is unmeasured confounder, coefficient = 0.5
## df10 

df10_3 = df10
df10_3$W = NA

## assuming the exclusion restriction holds

prob = rep(NA, 10000)

for(i in 1:10000)
  {
  
  prob[i]=13-0.2*df10_3$trt[i]+0.4*df10_3$X1[i]-0.39*df10_3$X2[i]+0.07*df10_3$X3[i]-0.12*df10_3$X4[i]-0.5*df10_3$X5[i]
  df10_3$W[i]=rbinom(1,1,1/(1+exp(-prob[i])))
}

## df20

df20_3 = df20 
df20_3$W = NA

## assuming the exclusion restriction holds

prob = rep(NA, 10000)

for(i in 1:10000)
  {
  
  prob[i]=13-0.2*df20_3$trt[i]+0.4*df20_3$X1[i]-0.39*df20_3$X2[i]+0.07*df20_3$X3[i]-0.12*df20_3$X4[i]-0.5*df20_3$X5[i]
  df20_3$W[i]=rbinom(1,1,1/(1+exp(-prob[i])))
}



## df30

df30_3 = df30
df30_3$W = NA

## assuming the exclusion restriction holds

prob = rep(NA, 10000)

for(i in 1:10000)
  {
  prob[i]=13-0.2*df30_3$trt[i]+0.4*df30_3$X1[i]-0.39*df30_3$X2[i]+0.07*df30_3$X3[i]-0.12*df30_3$X4[i]-0.5*df30_3$X5[i]
  df30_3$W[i]=rbinom(1,1,1/(1+exp(-prob[i])))
}

```

### Outcome P-continuous

The outcome is the PEG2 containation in patient's body

```{r Continuous outcome} 

## x5 is unmeasured confounder, coefficient = 0.04
## df10 

df10_4 = df10

## assuming the exclusion restriction holds

peg2 = rep(NA, 10000)

for(i in 1:10000)
  {
    peg2[i]=128.74-0.2*df10_4$trt[i]+0.04*df10_4$X1[i]-0.039*df10_4$X2[i]+0.03*df10_4$X3[i]-0.12*df10_4$X4[i]-0.04*df10_4$X5[i]
}

df10_4$P=peg2

## df20

df20_4 = df20 

## assuming the exclusion restriction holds

peg2 = rep(NA, 10000)

for(i in 1:10000)
  {
    peg2[i]=128.74-0.2*df20_4$trt[i]+0.04*df20_4$X1[i]-0.039*df20_4$X2[i]+0.03*df20_4$X3[i]-0.12*df20_4$X4[i]-0.04*df20_4$X5[i]
}

df20_4$P=peg2



## df30

df30_4 = df30

## assuming the exclusion restriction holds

peg2 = rep(NA, 10000)

for(i in 1:10000)
  {
    peg2[i]=128.74-0.2*df30_4$trt[i]+0.04*df30_4$X1[i]-0.039*df30_4$X2[i]+0.03*df30_4$X3[i]-0.12*df30_4$X4[i]-0.04*df30_4$X5[i]
}

df30_4$P=peg2

```



```{r Continuous outcome} 

## x5 is unmeasured confounder, coefficient = 0.08
## df10 

df10_5 = df10

## assuming the exclusion restriction holds

peg2 = rep(NA, 10000)

for(i in 1:10000)
  {
    peg2[i]=128.74-0.2*df10_5$trt[i]+0.04*df10_5$X1[i]-0.039*df10_5$X2[i]+0.03*df10_5$X3[i]-0.12*df10_5$X4[i]-0.08*df10_5$X5[i]
}

df10_5$P=peg2

## df20

df20_5 = df20 

## assuming the exclusion restriction holds

peg2 = rep(NA, 10000)

for(i in 1:10000)
  {
    peg2[i]=128.74-0.2*df20_5$trt[i]+0.04*df20_5$X1[i]-0.039*df20_5$X2[i]+0.03*df20_5$X3[i]-0.12*df20_5$X4[i]-0.08*df20_5$X5[i]
}

df20_5$P=peg2



## df30

df30_5 = df30

## assuming the exclusion restriction holds

peg2 = rep(NA, 10000)

for(i in 1:10000)
  {
    peg2[i]=128.74-0.2*df30_5$trt[i]+0.04*df30_5$X1[i]-0.039*df30_5$X2[i]+0.03*df30_5$X3[i]-0.12*df30_5$X4[i]-0.08*df30_5$X5[i]
}

df30_5$P=peg2

```


```{r Continuous outcome} 

## x3 is unmeasured confounder, coefficient = 0.12
## df10 

df10_6 = df10

## assuming the exclusion restriction holds

peg2 = rep(NA, 10000)

for(i in 1:10000)
  {
    peg2[i]=128.74-0.2*df10_6$trt[i]+0.04*df10_6$X1[i]-0.039*df10_6$X2[i]+0.03*df10_6$X3[i]-0.12*df10_6$X4[i]-0.12*df10_6$X5[i]
}

df10_6$P=peg2

## df20

df20_6 = df20 

## assuming the exclusion restriction holds

peg2 = rep(NA, 10000)

for(i in 1:10000)
  {
    peg2[i]=128.74-0.2*df20_6$trt[i]+0.04*df20_6$X1[i]-0.039*df20_6$X2[i]+0.03*df20_6$X3[i]-0.12*df20_6$X4[i]-0.12*df20_6$X5[i]
}

df20_6$P=peg2



## df30

df30_6 = df30

## assuming the exclusion restriction holds

peg2 = rep(NA, 10000)

for(i in 1:10000)
  {
    peg2[i]=128.74-0.2*df30_6$trt[i]+0.04*df30_6$X1[i]-0.039*df30_6$X2[i]+0.03*df30_6$X3[i]-0.12*df30_6$X4[i]-0.12*df30_6$X5[i]
}

df30_6$P=peg2

```
## Analysis of simulated data


1. Ideal model adjusted for all covariates, including the
unobserved confounder X2.
2. Conventional model adjusted only for the observed covariates
X1 and X3.
3. IV model implemented through the 2SLS Equations (1)
and (2), with the treatment effect estimated by ^a1 in
Equation (2).

We compare the results from implementing the three models. 



```{r, functions}
sample = function(data){
  df = sample_n(data, 1000)
  return(df)
}

ideal_model = function(data){
  m = lm(P~.-patientid - physicianid - pp, data = data)
  return(m)
}

conv_model = function(data){
  m = lm(P~.-patientid - physicianid - pp - X5, data = data)
  return(m)
}

ideal_model_b = function(data){
  m = glm(W~.-patientid - physicianid - pp, data = data, family = "binomial")
  return(m)
}

conv_model_b = function(data){
  m = glm(W~.-patientid - physicianid - pp - X5, data = data, family = "binomial")
  return(m)
}

RMSE = function(y, ypred) {
  RMSE <- sqrt(mean((y - ypred)^2))
  return(RMSE)
}

bias = function(data,alpha3){
  r_pp1_uc1 = mean(data[data$pp == 1 & data$X5 == 1,]$P)
  r_pp0_uc1 = mean(data[data$pp == 1 & data$X5 == 0,]$P)
  r_pp1 = mean(data[data$pp == 1,]$P)
  r_pp0 = mean(data[data$pp == 0,]$P)
  b = alpha3*mean(data$X5)*(((r_pp1_uc1-r_pp0_uc1)/(r_pp1-r_pp0))-1)
  return(b)
}

bias_b = function(data,alpha3){
  r_pp1_uc1 = mean(data[data$pp == 1 & data$X5 == 1,]$W)
  r_pp0_uc1 = mean(data[data$pp == 1 & data$X5 == 0,]$W)
  r_pp1 = mean(data[data$pp == 1,]$W)
  r_pp0 = mean(data[data$pp == 0,]$W)
  b = alpha3*mean(data$X5)*(((r_pp1_uc1-r_pp0_uc1)/(r_pp1-r_pp0))-1)
  return(b)
}

pbias = function(rd_true, alpha){
  p = (alpha-rd_true)/rd_true*100
  return(p)
}
```

```{r, analysis}
set.seed(15)

df10000=list(df10_1,df20_1,df30_1,df10_2,df20_2,df30_2,df10_3,df20_3,df30_3)

drmse=matrix(NA, nrow=9, ncol=2)

for(i in 1:9){
  drmse[i,1]=RMSE(ideal_model_b(sample(df10000[[i]]))$fitted.values, df10000[[i]]$W)
  drmse[i,2]=RMSE(conv_model_b(sample(df10000[[i]]))$fitted.values, df10000[[i]]$W)
}

drmse=data.frame(drmse)

dbias=matrix(NA, nrow=9, ncol=2)

for (i in 1:9){
  dbias[i,1]=bias_b(df10000[[i]], summary(ideal_model_b(sample(df10000[[i]])))$coefficients[6])
  dbias[i,2]=bias_b(df10000[[i]], summary(conv_model_b(sample(df10000[[i]])))$coefficients[6])
}

dbias=data.frame(dbias)

row.names(drmse)=c("pp=0.3,uc=0.3","pp=0.3,uc=0.4","pp=0.3,uc=0.5","pp=0.5,uc=0.3","pp=0.5,uc=0.4","pp=0.5,uc=0.5","pp=0.7,uc=0.3","pp=0.7,uc=0.4","pp=0.7,uc=0.5")
colnames(drmse)=c("IV model","Conventional model")

row.names(dbias)=c("pp=0.3,uc=0.3","pp=0.3,uc=0.4","pp=0.3,uc=0.5","pp=0.5,uc=0.3","pp=0.5,uc=0.4","pp=0.5,uc=0.5","pp=0.7,uc=0.3","pp=0.7,uc=0.4","pp=0.7,uc=0.5")
colnames(dbias)=c("IV model","Conventional model")

kable(drmse, caption="RMSE of models", align="c")
kable(dbias, caption="Bias of models", align="c")
```